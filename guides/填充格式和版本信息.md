# 填充格式和版本信息

这一节，主要是把之前空着的保留区域填上，方便计算惩罚分数。

## 格式信息(Format Information)

格式信息由纠错级别和选择的掩码模式组成，也就是说我们还得先选择掩码模式，然后填充信息，在回去计算惩罚分数。

纠错级别有4种，掩码模式有8种，所以格式信息一共有32种，所有的格式信息都可以在[format-version-tables](https://www.thonky.com/qr-code-tutorial/format-version-tables)找到。

但为了完全理解二维码原理，我们还是有必要理解以下这些信息是如何计算出来的。

### 计算

格式信息总是15位长，首先我们需要用纠错级别和掩码模式生成一个5位的数据，然后对其生成10位的纠错码，最后我们进行掩码，即与101010000010010进行异或，最后产生的数据即为格式信息。

1. 确定纠错级别的信息。

| 纠错级别 | 对应的数据(二进制) |
| :------: | :----------------: |
|    L     |         01         |
|    M     |         00         |
|    Q     |         11         |
|    H     |         10         |

**注：这个对应的顺序可和直觉顺序不一样**

2. 确定掩码模式对应的信息

我们知道掩码模式有8种，每种都有一个对应的数字0-7，我们把这个整数转换为三位二进制。

如掩码模式4  -> 100

如果我们选择L级别，掩码模式4，那么现在数据前5位为01100

3. 生成纠错码

生成纠错码的过程，我们还是使用Reed-Solomon Error Correction算法。

标准规定，当计算格式信息纠错码时，我们应选用以下多项式为生成多项式：
$$
x^{10} + x^8 + x^5 + x^4 + x^2 + x + 1
$$
只取系数的话为：10100110111

而消息多项式就是我们前面由纠错级别和掩码模式确定好的01100

首先，我们需要将消息多项式扩充到15位，011000000000000

然后去掉左侧的零项 11000000000000

接下来的步骤是：

* 在生成多项式右侧填充0，使其长度与处理后的消息多项式相同。
* 将两个长度相同的多项式进行异或运算
* 去掉结果左侧的零项

重复上述步骤，直到结果长度小于等于10，如果小于10，我们在**左侧添0**使其长度达到10

4. 掩码

将之前的数据和生成纠错码拼接起来，然后与101010000010010进行异或：

011001000111101 ^ 101010000010010 = 110011000101111

那么110011000101111就是在纠错级别L，掩码模式4下的格式信息。

### 填充

现在我们已经得到了格式信息，现在我们把他填充到二维码的保留区域中。

![The layout of format string bits, where 14 is the most significant bit and 0 is the least significant bit](https://www.thonky.com/qr-code-tutorial/format-layout.png?a=)

如图，蓝色区域就是格式信息填充位置，其中**0位置对应我们格式信息的最高位，14对应最低位。且注意中间经过的时序模式要保持不变，填充时要选择跳过**

如此对于 110011000101111，我们填充后，如下图：

![img](https://www.thonky.com/qr-code-tutorial/example-format.png)

## 版本信息(Version Information)

版本信息只存在于版本大于等于7的情况下。

版本信息由6位选定二维码的版本数(二进制)表示和12位相应的纠错码组成，一共18位

对于消息多项式，比如取版本7，转化为六位二进制，为000111

标准规定，生成版本信息时，需使用以下生成多项式：
$$
x^{12} + x^{11} + x^{10} + x^9 + x^8 + x^5 + x^2 + 1
$$
取其系数为：1111100100101

接下来的步骤与生成格式信息的步骤基本一致，只不过现在我们需要将消息多项式扩充到18位，而不是15位。

并且我们需要当结果长度小于等于12位我们结束，小于12位时，我们还是在**左侧补零**到12位

第一步将消息多项式补零到18位：

000111000000000000

第二步去掉左侧的零：

111000000000000

第三步将生成多项式扩充到与上述结果等长：

111110010010100

第四步将两个式子异或：

1110000000000 ^ 111110010010100 = 110010010100

现在结果已经是12位了所以我们不需要在继续。

现在我们将数据拼接起来：

000111110010010100

这就是version 7 的版本信息，所有的版本信息也都可以在[format-version-tables](https://www.thonky.com/qr-code-tutorial/format-version-tables)这里找到

### 填充

版本信息填充的位置就是我们在版本大于等于7时保留的两个3\*6块，对于这两个块，我们填充的顺序还有所区别

#### 左下角的块

| 0    | 3    | 6    | 9    | 12   | 15   |
| ---- | ---- | ---- | ---- | ---- | ---- |
| 1    | 4    | 7    | 10   | 13   | 16   |
| 2    | 5    | 8    | 11   | 14   | 17   |

#### 右上角的块

| 0    | 1    | 2    |
| ---- | ---- | ---- |
| 3    | 4    | 5    |
| 6    | 7    | 8    |
| 9    | 10   | 11   |
| 12   | 13   | 14   |
| 15   | 16   | 17   |

其中每一位对应数据应该如下：

| 17   | 16   | 15   | 14   | 13   | 12   | 11   | 10   | 9    | 8    | 7    | 6    | 5    | 4    | 3    | 2    | 1    | 0    |
| ---- | ---- | ---- | ---- | ---- | ---- | ---- | ---- | ---- | ---- | ---- | ---- | ---- | ---- | ---- | ---- | ---- | ---- |
| 0    | 0    | 0    | 1    | 1    | 1    | 1    | 1    | 0    | 0    | 1    | 0    | 0    | 1    | 0    | 1    | 0    | 0    |

填入后，结果应该如下：

![img](https://www.thonky.com/qr-code-tutorial/version-example.png)

## 输出最终二维码

填充完格式信息和版本信息(如果需要的话)后，计算出最合适的掩码模式，并应用后，我们就得到了最终的二维码。

但在输出时，**我们还要在二维码周围加上4个数据位宽的空白区域，作为静态区域。**

下面这个为 version 1 纠错级别Q，输入数据“HELLO WORLD”，并采用了Alphanumeric编码的二维码：

![img](https://www.thonky.com/qr-code-tutorial/hello-world-final.png)

