# 构建最终数据

这一节，我们主要进行数据交错。

## 分块

但在那之前，我们需要对上一节内容进行一个补充，当我们浏览[error-correction-table](https://www.thonky.com/qr-code-tutorial/error-correction-table)时，我们发现对于不同版本和不同纠错级别的二维码，可能存在具有不同块的情况，比如：

**如果选定的二维码只有一个块，那么就不再需要交错，我们只需把生成的纠错码放在编码数据之后，然后直接进入下一节**

对于version 5-Q，表中数据为：
$$
62\space18\space2\space15\space2\space16
$$
第一项我们已经知道，代表这个二维码可以容纳的数据码长度，第二项代表每块中纠错码长度，这之后每两项代表一组，这里有两组，

第一组2 15代表这组有两个块，每块有15个数据字，第二组2 16代表这组有两个块，每块16个数据字。

而 2\*15 + 2\*16 = 62。因此对于version 5-Q 一共有4个块，而每块因为数据不同，所以每块都要有不同的纠错码，但纠错码的长度都为18。具体可以看我们如下的例子：

| Block |                        Data codewords                        |               Data codewords as Integers               |                  Error Correction codewords                  |
| :---: | :----------------------------------------------------------: | :----------------------------------------------------: | :----------------------------------------------------------: |
|   1   | (codeword #1) 01000011<br/>(codeword #2) 01010101<br/>(codeword #3) 01000110<br/>(codeword #4) 10000110<br/>(codeword #5) 01010111<br/>(codeword #6) 00100110<br/>(codeword #7) 01010101<br/>(codeword #8) 11000010<br/>(codeword #9) 01110111<br/>(codeword #10) 00110010<br/>(codeword #11) 00000110<br/>(codeword #12) 00010010<br/>(codeword #13) 00000110<br/>(codeword #14) 01100111<br/>(codeword #15) 00100110 |     67,85,70,134,87,38,85,194,119,50,6,18,6,103,38     | 213 199 11 45 115 247 241 223 229 248 154 117 154 111 86 161 111 39 |
|   2   | (codeword #16) 11110110<br/>(codeword #17) 11110110<br/>(codeword #18) 01000010<br/>(codeword #19) 00000111<br/>(codeword #20) 01110110<br/>(codeword #21) 10000110<br/>(codeword #22) 11110010<br/>(codeword #23) 00000111<br/>(codeword #24) 00100110<br/>(codeword #25) 01010110<br/>(codeword #26) 00010110<br/>(codeword #27) 11000110<br/>(codeword #28) 11000111<br/>(codeword #29) 10010010<br/>(codeword #30) 00000110 |   246,246,66,7,118,134,242,7,38,86,22,198,199,146,6    | 87 204 96 60 202 182 124 157 200 134 27 129 209 17 163 163 120 133 |
|   3   | (codeword #31) 10110110<br/>(codeword #32) 11100110<br/>(codeword #33) 11110111<br/>(codeword #34) 01110111<br/>(codeword #35) 00110010<br/>(codeword #36) 00000111<br/>(codeword #37) 01110110<br/>(codeword #38) 10000110<br/>(codeword #39) 01010111<br/>(codeword #40) 00100110<br/>(codeword #41) 01010010<br/>(codeword #42) 00000110<br/>(codeword #43) 10000110<br/>(codeword #44) 10010111<br/>(codeword #45) 00110010<br/>(codeword #46) 00000111 |  182,230,247,119,50,7,118,134,87,38,82,6,134,151,50,7  | 148 116 177 212 76 133 75 242 238 76 195 230 189 10 108 240 192 141 |
|   4   | (codeword #47) 01000110<br/>(codeword #48) 11110111<br/>(codeword #49) 01110110<br/>(codeword #50) 01010110<br/>(codeword #51) 11000010<br/>(codeword #52) 00000110<br/>(codeword #53) 10010111<br/>(codeword #54) 00110010<br/>(codeword #55) 11100000<br/>(codeword #56) 11101100<br/>(codeword #57) 00010001<br/>(codeword #58) 11101100<br/>(codeword #59) 00010001<br/>(codeword #60) 11101100<br/>(codeword #61) 00010001<br/>(codeword #62) 11101100 | 70,247,118,86,194,6,151,50,16,236,17,236,17,236,17,236 | 235 159 5 173 24 147 59 33 106 40 255 172 82 2 131 32 178 236 |

现在我们已经将数据分块，都为每一块都生成了对应的纠错码。

## 交错

### 数据字

对于数据字，我们一共有四组：

| 1    | 2    | 3    | 4    | 5    | 6    | 7    | 8    | 9    | 10   | 11   | 12   | 13   | 14   | 15   | 16   |
| ---- | ---- | ---- | ---- | ---- | ---- | ---- | ---- | ---- | ---- | ---- | ---- | ---- | ---- | ---- | ---- |
| 676  | 85   | 70   | 134  | 87   | 38   | 85   | 194  | 119  | 50   | 6    | 18   | 6    | 103  | 38   |      |
| 246  | 246  | 66   | 7    | 118  | 134  | 242  | 7    | 38   | 86   | 22   | 198  | 199  | 146  | 6    |      |
| 182  | 230  | 247  | 119  | 50   | 7    | 118  | 134  | 87   | 38   | 82   | 6    | 134  | 151  | 50   | 7    |
| 70   | 247  | 118  | 86   | 194  | 6    | 151  | 50   | 16   | 236  | 17   | 236  | 17   | 236  | 17   | 236  |

每次我们取每块的第一项，即表的第一列：

676 246 182 70

第二次我们取每块的第二项，即表的第二列，放到之前结果的后面：

676 246 182 70 85 246 230 247

以此类推，直到第16列，因为前两块没有第16项，所以我们直接取剩下的两项，放到后面。

交错的最终结果为：

67, 246, 182, 70, 85, 246, 230, 247, 70, 66, 247, 118, 134, 7, 119, 86, 87, 118, 50, 194, 38, 134, 7, 6, 85, 242, 118, 151, 194, 7, 134, 50, 119, 38, 87, 16, 50, 86, 38, 236, 6, 22, 82, 17, 18, 198, 6, 236, 6, 199, 134, 17, 103, 146, 151, 236, 38, 6, 50, 17, 7, 236

### 纠错码

对于纠错码步骤是一样的。

|  1   |  2   |  3   |  4   |  5   |  6   |  7   |  8   |  9   |  10  |  11  |  12  |  13  |  14  |  15  |  16  |  17  |  18  |
| :--: | :--: | :--: | :--: | :--: | :--: | :--: | :--: | :--: | :--: | :--: | :--: | :--: | :--: | :--: | :--: | :--: | :--: |
| 213  | 199  |  11  |  45  | 115  | 247  | 241  | 223  | 229  | 248  | 154  | 117  | 154  |  11  |  86  | 161  | 111  |  39  |
|  87  | 204  |  96  |  60  | 202  | 182  | 124  | 157  | 200  | 134  |  27  | 129  | 209  |  17  | 163  | 163  | 120  | 133  |
| 148  | 116  | 177  | 212  |  76  | 133  |  75  | 242  | 238  |  76  | 195  | 230  | 189  |  10  | 108  | 240  | 192  | 141  |
| 235  | 159  |  5   | 173  |  24  | 147  |  59  |  33  | 106  |  40  | 255  | 172  |  82  |  2   | 131  |  32  | 178  | 236  |

依然是，取每个块纠错码的第一项，即表的第一列：

213 87 148 235

然后取每个块纠错码的第二项，即表的第二项：

213 87 148 235 199 204 116 159

以此类推，直到最后一列。

最终结果为：

213, 87, 148, 235, 199, 204, 116, 159, 11, 96, 177, 5, 45, 60, 212, 173, 115, 202, 76, 24, 247, 182, 133, 147, 241, 124, 75, 59, 223, 157, 242, 33, 229, 200, 238, 106, 248, 134, 76, 40, 154, 27, 195, 255, 117, 129, 230, 172, 154, 209, 189, 82, 111, 17, 10, 2, 86, 163, 108, 131, 161, 163, 240, 32, 111, 120, 192, 178, 39, 133, 141, 236

## 构建最终数据

现在我们把交错后的纠错码放到数据码之后，即：

67, 246, 182, 70, 85, 246, 230, 247, 70, 66, 247, 118, 134, 7, 119, 86, 87, 118, 50, 194, 38, 134, 7, 6, 85, 242, 118, 151, 194, 7, 134, 50, 119, 38, 87, 16, 50, 86, 38, 236, 6, 22, 82, 17, 18, 198, 6, 236, 6, 199, 134, 17, 103, 146, 151, 236, 38, 6, 50, 17, 7, 236, 213, 87, 148, 235, 199, 204, 116, 159, 11, 96, 177, 5, 45, 60, 212, 173, 115, 202, 76, 24, 247, 182, 133, 147, 241, 124, 75, 59, 223, 157, 242, 33, 229, 200, 238, 106, 248, 134, 76, 40, 154, 27, 195, 255, 117, 129, 230, 172, 154, 209, 189, 82, 111, 17, 10, 2, 86, 163, 108, 131, 161, 163, 240, 32, 111, 120, 192, 178, 39, 133, 141, 236

这就是我们最终的数据。

但当我们在下一节向空白二维码中填充数据时，需要的是二进制数据，所以我们还需要转换为二进制：

对于每个整数，我们需要将他们转化为8位二进制。(位数不足，在左侧补零）

转换后结果如下：

0100001111110110101101100100011001010101111101101110011011110111010001100100001011110111011101101000011000000111011101110101011001010111011101100011001011000010001001101000011000000111000001100101010111110010011101101001011111000010000001111000011000110010011101110010011001010111000100000011001001010110001001101110110000000110000101100101001000010001000100101100011000000110111011000000011011000111100001100001000101100111100100101001011111101100001001100000011000110010000100010000011111101100110101010101011110010100111010111100011111001100011101001001111100001011011000001011000100000101001011010011110011010100101011010111001111001010010011000001100011110111101101101000010110010011111100010111110001001011001110111101111110011101111100100010000111100101110010001110111001101010111110001000011001001100001010001001101000011011110000111111111101110101100000011110011010101100100110101101000110111101010100100110111100010001000010100000001001010110101000110110110010000011101000011010001111110000001000000110111101111000110000001011001000100111100001011000110111101100

### 添加剩余位

上面的这一长串，事实上还不能填满对应的二维码。因此在长度不够的情况下，我们还需要添加剩余位。

对于不同版本剩余位的信息如下：

| Version | Remainder bits |
| :-----: | :------------: |
|    1    |       0        |
|   2~6   |       7        |
|  7~13   |       0        |
|  14~20  |       3        |
|  21~27  |       4        |
|  28~34  |       3        |
|  35~40  |       0        |

因此，对于version 5-Q，我们需要在数据末尾添加7位剩余位，即

0100001111110110101101100100011001010101111101101110011011110111010001100100001011110111011101101000011000000111011101110101011001010111011101100011001011000010001001101000011000000111000001100101010111110010011101101001011111000010000001111000011000110010011101110010011001010111000100000011001001010110001001101110110000000110000101100101001000010001000100101100011000000110111011000000011011000111100001100001000101100111100100101001011111101100001001100000011000110010000100010000011111101100110101010101011110010100111010111100011111001100011101001001111100001011011000001011000100000101001011010011110011010100101011010111001111001010010011000001100011110111101101101000010110010011111100010111110001001011001110111101111110011101111100100010000111100101110010001110111001101010111110001000011001001100001010001001101000011011110000111111111101110101100000011110011010101100100110101101000110111101010100100110111100010001000010100000001001010110101000110110110010000011101000011010001111110000001000000110111101111000110000001011001000100111100001011000110111101100**0000000**

现在我们得到了最终数据。